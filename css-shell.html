<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>CSS Shell Test</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="/style.css">
<style>
  /* === Shell-only overrides ===
     style.css carries the full layout (body-scroll, scroll-snap, sticky input,
     field-sizing, CSS-drawn buttons, placeholder text). This block only adds
     things the shell needs that production doesn't. */

  /* Show + and / buttons without JS (production shows via .visible class) */
  .btn-slash, .btn-file {
    display: flex !important;
  }
</style>
</head>
<body>

  <!-- Messages area â€” body-scroll layout -->
  <div class="messages" id="messages">
    <div class="msg-system">CSS shell â€” layout test bed with live diagnostics</div>
    <pre id="diag" style="font-family:var(--mono);font-size:0.72rem;color:var(--text-dim);line-height:1.8;padding:12px;background:var(--surface);border-radius:8px;white-space:pre-wrap;"></pre>

    <!-- Dummy messages â€” enough to guarantee 2-3x viewport overflow -->
    <div class="msg-user">Can you help me refactor this module?</div>
    <div class="msg-assistant"><p>Sure. The main thing to check here is whether the body grows past the viewport height, enabling Safari Full Page screenshots.</p></div>
    <div class="msg-user">The scroll is on the document body now, right?</div>
    <div class="msg-assistant"><p>Yes. <code>.messages</code> has no <code>overflow-y</code> â€” content flows into the document. Safari's Full Page screenshot captures <code>document.documentElement.scrollHeight</code>, so the page must be taller than the viewport for the "Full Page" tab to appear.</p></div>
    <div class="msg-user">What about the input area?</div>
    <div class="msg-assistant"><p><code>position: sticky; bottom: 0</code> keeps it pinned at the viewport bottom while the document scrolls. <code>will-change: transform</code> promotes it to its own compositor layer, preventing flicker during iOS keyboard animation.</p></div>
    <div class="msg-user">And scroll-snap?</div>
    <div class="msg-assistant"><p><code>scroll-snap-type: y proximity</code> on <code>html</code> auto-follows new content when you're near the bottom, but leaves you alone when you've scrolled up to read. The <code>.snap-anchor</code> at the end of messages is the snap target (<code>scroll-snap-align: end</code>). No JS scroll tracking needed.</p></div>
    <div class="msg-user">Tell me about the flex layout.</div>
    <div class="msg-assistant"><p><code>flex: 1 0 auto</code> means grow to fill, never shrink, content-sized basis. With <code>flex: 1</code> (i.e. <code>1 1 0</code>), messages can collapse to zero height â€” the full shorthand matters.</p></div>
    <div class="msg-user">Why not position: fixed for the input area?</div>
    <div class="msg-assistant"><p>On iOS, <code>position: fixed</code> is positioned relative to the visual viewport, which lies about its height in standalone mode (793px vs 852px). Sticky participates in document flow, sidestepping the issue.</p></div>
    <div class="msg-user">How does field-sizing: content work?</div>
    <div class="msg-assistant"><p>The textarea auto-grows to fit its content â€” no JS input listener needed. <code>max-height: 40dvh</code> caps it at 40% of the viewport, then <code>overflow-y: auto</code> makes it scrollable. Safari 26.2+ supports it.</p></div>
    <div class="msg-user">How does Safari Full Page screenshot work?</div>
    <div class="msg-assistant"><p>Safari captures <code>document.documentElement.scrollHeight</code>. If content is taller than the viewport, "Full Page" appears in the screenshot editor. With the old element-scroll layout, the document was exactly one viewport tall â€” no Full Page option.</p></div>
    <div class="msg-user">What should I check in this test?</div>
    <div class="msg-assistant"><p>Three things: (1) Input bar stays at bottom while scrolling. (2) Safari screenshot shows "Full Page" tab. (3) Keyboard open/close doesn't break the layout. Also: type in the textarea to verify field-sizing auto-grow, and tap send to start the streaming simulator.</p></div>
    <div class="msg-user">This is message 10 â€” should be well past one viewport.</div>
    <div class="msg-assistant"><p>Each message pair is roughly 80-100px. With 10+ pairs plus the diagnostic panel, we're at 1500-2000px â€” well past any phone viewport.</p></div>
    <div class="msg-user">Adding more to be sure.</div>
    <div class="msg-assistant"><p>The Full Page option only appears when there's genuine overflow. More content = more confidence.</p></div>
    <div class="msg-user">What about the CSS-drawn buttons?</div>
    <div class="msg-assistant"><p>The <code>+</code> and <code>/</code> symbols are drawn with <code>::before</code> and <code>::after</code> pseudo-elements â€” absolute-positioned bars with <code>currentColor</code>. Geometrically centred, no font metrics involved. The text content is hidden with <code>font-size: 0</code>.</p></div>
    <div class="msg-user">Last message â€” roughly 3x viewport height now.</div>
    <div class="msg-assistant"><p>If the input bar is still at the bottom and the page scrolls freely, body-scroll works. Take a screenshot â€” you should see the Full Page tab.</p></div>
    <div class="snap-anchor"></div>
  </div>

  <script>
  // Diagnostic readouts â€” updates live on resize/viewport change
  function measure() {
    const d = document.getElementById('diag');
    const vv = window.visualViewport;
    const standalone = window.matchMedia('(display-mode: standalone)').matches;
    const bodyCS = getComputedStyle(document.body);
    const htmlCS = getComputedStyle(document.documentElement);

    const docScrollH = document.documentElement.scrollHeight;
    const overflow = docScrollH > window.innerHeight;
    d.textContent = [
      `mode:        ${standalone ? 'STANDALONE' : 'browser'}`,
      `screen.h:    ${screen.height}px`,
      `innerHeight: ${window.innerHeight}px`,
      `vv.height:   ${vv ? vv.height + 'px' : 'n/a'}`,
      ``,
      `body.h (computed): ${bodyCS.height}`,
      `body.scrollH:      ${document.body.scrollHeight}px`,
      `doc.scrollH:       ${docScrollH}px`,
      `window.scrollY:    ${Math.round(window.scrollY)}px`,
      `OVERFLOW:          ${overflow ? 'YES âœ“' : 'NO âœ— (need more content)'}`,
      ``,
      `html overflow:     ${htmlCS.overflow || htmlCS.overflowY || 'auto'}`,
      `body.offsetH:      ${document.body.offsetHeight}px`,
      `messages.h:        ${getComputedStyle(document.querySelector('.messages')).height}`,
      `input sticky:      ${getComputedStyle(document.querySelector('.input-area')).position}`,
    ].join('\n');
  }

  measure();
  window.addEventListener('resize', measure);
  window.addEventListener('scroll', measure);
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', measure);
    window.visualViewport.addEventListener('scroll', measure);
  }
  setTimeout(measure, 500);

  </script>

  <div class="input-area">
    <textarea class="input-field" placeholder="Message Claude..." rows="1" autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
    <div class="staged-deposits" id="stagedDeposits"></div>
    <div class="btn-bar">
      <button class="btn-circle btn-file" aria-label="Attach" id="fileBtn">+</button>
      <button class="btn-circle btn-slash" aria-label="Commands" id="slashBtn">/</button>
      <button class="btn-lozenge folder" id="folderBtn"><span class="label" id="project"></span></button>
      <button class="btn-lozenge context" id="contextBtn"><span class="pct" id="contextPct"></span><span class="push-denied" id="pushDenied" title="Notifications blocked">ðŸ”‡</span></button>
      <button class="btn-circle btn-send" aria-label="Send" id="sendBtn">&#x2191;</button>
    </div>
  </div>

  <!-- Streaming simulator â€” tap send to toggle. Tests scroll-snap during rapid DOM appends. -->
  <script>
  let streaming = false;
  let streamCount = 0;
  const sendBtn = document.getElementById('sendBtn');
  const messages = document.getElementById('messages');
  const anchor = messages.querySelector('.snap-anchor');

  sendBtn.addEventListener('click', () => {
    streaming = !streaming;
    sendBtn.style.background = streaming ? 'var(--red)' : '';
    if (streaming) appendStream();
  });

  function appendStream() {
    if (!streaming) return;
    streamCount++;
    const div = document.createElement('div');
    div.className = streamCount % 2 ? 'msg-assistant' : 'msg-user';
    div.innerHTML = streamCount % 2
      ? `<p>Streamed response #${streamCount} â€” scroll-snap should follow if you're near the bottom, leave you alone if you've scrolled up.</p>`
      : `Simulated message #${streamCount}`;
    messages.insertBefore(div, anchor);
    setTimeout(appendStream, 800);
  }
  </script>

</body>
</html>
